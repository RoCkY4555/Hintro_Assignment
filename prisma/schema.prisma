// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/client"
}

datasource db {
  provider = "postgresql"
}

enum CabStatus {
  AVAILABLE
  BUSY
  OFFLINE
}

enum BookingStatus {
  PENDING
  POOLED
  IN_TRANSIT
  COMPLETED
  CANCELLED
}

enum RideStatus {
  FORMING
  CONFIRMED
  IN_TRANSIT
  COMPLETED
  CANCELLED
}

model Passenger {
  id        String    @id @default(uuid())
  name      String
  phone     String    @unique
  email     String    @unique
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  bookings  Booking[]

  @@map("passengers")
}

model Cab {
  id              String    @id @default(uuid())
  licensePlate    String    @unique @map("license_plate")
  driverName      String    @map("driver_name")
  totalSeats      Int       @default(4) @map("total_seats")
  luggageCapacity Int       @default(4) @map("luggage_capacity")
  status          CabStatus @default(AVAILABLE)
  locationLat     Float     @default(0) @map("location_lat")
  locationLng     Float     @default(0) @map("location_lng")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  rides           Ride[]

  @@index([status])
  @@map("cabs")
}

model Booking {
  id               String        @id @default(uuid())
  passengerId      String        @map("passenger_id")
  pickupLat        Float         @map("pickup_lat")
  pickupLng        Float         @map("pickup_lng")
  dropoffLat       Float         @map("dropoff_lat")
  dropoffLng       Float         @map("dropoff_lng")
  luggageCount     Int           @default(1) @map("luggage_count")
  status           BookingStatus @default(PENDING)
  detourToleranceKm Float        @default(5.0) @map("detour_tolerance_km")
  createdAt        DateTime      @default(now()) @map("created_at")
  updatedAt        DateTime      @updatedAt @map("updated_at")

  passenger      Passenger       @relation(fields: [passengerId], references: [id])
  ridePassengers RidePassenger[]

  @@index([status])
  @@index([passengerId])
  @@map("bookings")
}

model Ride {
  id            String     @id @default(uuid())
  cabId         String     @map("cab_id")
  status        RideStatus @default(FORMING)
  routeJson     Json?      @map("route_json")
  totalDistance  Float      @default(0) @map("total_distance")
  totalPrice    Float      @default(0) @map("total_price")
  version       Int        @default(1)
  createdAt     DateTime   @default(now()) @map("created_at")
  updatedAt     DateTime   @updatedAt @map("updated_at")

  cab            Cab             @relation(fields: [cabId], references: [id])
  ridePassengers RidePassenger[]

  @@index([status])
  @@index([cabId])
  @@map("rides")
}

model RidePassenger {
  id              String  @id @default(uuid())
  rideId          String  @map("ride_id")
  bookingId       String  @map("booking_id")
  sequenceOrder   Int     @default(0) @map("sequence_order")
  individualPrice Float   @default(0) @map("individual_price")
  pickupEta       Int?    @map("pickup_eta_minutes")

  ride    Ride    @relation(fields: [rideId], references: [id], onDelete: Cascade)
  booking Booking @relation(fields: [bookingId], references: [id])

  @@unique([rideId, bookingId])
  @@map("ride_passengers")
}
